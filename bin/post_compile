#!/bin/bash
# Heroku post-compile hook
# 1. Swap GUI opencv (pulled by mediapipe as dep) with headless variant
#    so we don't need libGL / X11 system libraries.
# 2. Remove jax/jaxlib — only used by mediapipe Model Maker, not by legacy
#    Pose / FaceMesh solutions that we use for body-language analysis.
#    This saves ~200 MB of slug space.

echo "-----> Swapping opencv-contrib-python → headless variant"
pip uninstall -y opencv-contrib-python 2>/dev/null || true
pip install --no-deps --force-reinstall opencv-contrib-python-headless 2>&1 | tail -3
python -c "import cv2; print('       cv2 OK:', cv2.__version__)"

echo "-----> Removing unused heavy dependencies (jax/jaxlib)"
pip uninstall -y jax jaxlib ml-dtypes opt-einsum 2>/dev/null || true

echo "-----> Verifying mediapipe legacy API"
python -c "
import mediapipe as mp
p = mp.solutions.pose
f = mp.solutions.face_mesh
print('       mediapipe OK:', mp.__version__)
print('       Pose:', p.Pose)
print('       FaceMesh:', f.FaceMesh)
"

echo "-----> post_compile complete"
